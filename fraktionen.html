<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fraktionen</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<style>
*{ box-sizing:border-box; }

body{
  margin:0;
  background:#0e0e0e;
  font-family:Arial;
  color:white;
  overflow-x:hidden;
}

/* ===== TOPBAR / SEARCH ===== */
#topBar{
  position:sticky;
  top:0;
  z-index:1100;
  padding:12px 24px 10px 24px;
  background:linear-gradient(to bottom, rgba(14,14,14,0.95), rgba(14,14,14,0.7), rgba(14,14,14,0));
  backdrop-filter: blur(10px);
}

#searchWrap{ position:relative; display:inline-block; }
#searchIcon{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  color:#00ffc3;
  font-size:14px;
  opacity:0.9;
}
#searchBox{
  width:min(340px, calc(100vw - 48px));
  padding:10px 12px 10px 34px;
  border-radius:8px;
  border:none;
  background:#222;
  color:white;
  outline:none;
}

/* ===== GRID ===== */
#container{
  display:flex;
  flex-wrap:wrap;
  gap:22px;
  padding:10px 24px 110px 24px;
  align-items:flex-start;
}

/* ===== CARD ===== */
.card{
  padding:18px;
  border-radius:22px;
  min-width:320px;
  max-width:420px;
  flex:0 1 360px;
  background:#161616;
  box-shadow:0 0 25px #00ffc322;
  transition:0.25s;
  display:flex;
  flex-direction:column;
}
.card:hover{
  transform:translateY(-6px);
  box-shadow:0 0 32px #00ffc344;
}
.card h3{
  margin:0 0 12px 0;
  font-size:20px;
  font-weight:800;
  letter-spacing:0.4px;
}

/* ===== MEMBER LIST WRAP (GRAUEN BLOCK WEG) ===== */
.memberList{
  background:transparent;
  border:none;
  border-radius:0;
  padding:0;
}

/* ===== MEMBER ROW ===== */
.member{
  background:linear-gradient(145deg, rgba(35,35,35,0.92), rgba(12,12,12,0.92));
  border:1px solid rgba(255,255,255,0.06);
  padding:12px 14px;
  border-radius:14px;
  margin-bottom:10px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:grab;
  user-select:none;
  transition:0.2s ease;
}
.member:last-child{ margin-bottom:0; }
.member:hover{
  border:1px solid rgba(0,255,195,0.35);
  box-shadow:0 0 18px rgba(0,255,195,0.15);
}
.member:active{ cursor:grabbing; }

.memberLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}

/* Namen + Stern grÃ¶ÃŸer */
.memberName{
  font-size:16px;
  font-weight:800;
  color:#f1f1f1;
  letter-spacing:0.2px;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* ===== LEADER ===== */
.leader-star{
  cursor:pointer;
  font-size:18px;
  opacity:0.95;
  line-height:1;
}

/* Leader aktiv: Stern gold + Zeile goldener Rahmen */
.leader-active{
  color:#ffd54a;
  text-shadow:0 0 10px rgba(255,213,74,0.35);
}

.member.leaderRow{
  border:1px solid rgba(255,213,74,0.85);
  box-shadow:0 0 16px rgba(255,213,74,0.18);
}

/* ===== DELETE BUTTON (SMALL) ===== */
.delBtn{
  background:rgba(255,59,59,0.18);
  border:1px solid rgba(255,59,59,0.45);
  color:#ff6b6b;
  border-radius:10px;
  padding:6px 9px;
  font-weight:900;
  font-size:12px;
  cursor:pointer;
}
.delBtn:hover{
  background:rgba(255,59,59,0.28);
  color:#fff;
}

/* ===== BUTTONS ===== */
button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  font-family:Arial;
}

.primary{
  background:#00ffc3;
  color:black;
  box-shadow:0 0 18px #00ffc322;
}

/* Outline-Style wie dangerSoft */
.outline{
  background:transparent;
  border:1px solid rgba(255,255,255,0.12);
  padding:9px 10px;
  border-radius:12px;
  font-size:12px;
}

/* â€žFraktion lÃ¶schenâ€œ (rot outline) */
.dangerSoft{
  background:transparent;
  color:#ff6b6b;
  border:1px solid rgba(255,59,59,0.55);
  padding:9px 10px;
  border-radius:12px;
  font-size:12px;
}
.dangerSoft:hover{
  background:rgba(255,59,59,0.12);
  color:white;
}

/* â€ž+ Mitgliedâ€œ soll wie dangerSoft aussehen, aber tÃ¼rkis */
.addSoft{
  background:transparent;
  color:#00ffc3;
  border:1px solid rgba(0,255,195,0.55);
  padding:9px 10px;
  border-radius:12px;
  font-size:12px;
}
.addSoft:hover{
  background:rgba(0,255,195,0.10);
  color:white;
}

/* Buttons row */
.btnRow{
  display:flex;
  gap:12px;
  margin-top:12px;
  align-items:center;
}

/* Add form */
.add-form{
  display:none;
  flex-direction:column;
  gap:10px;
  margin-top:12px;
  padding:12px;
  border-radius:16px;
  background:rgba(0,0,0,0.18);
  border:1px solid rgba(255,255,255,0.06);
}
.add-form input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:none;
  background:#222;
  color:white;
  outline:none;
}

/* ===== BACK BUTTON ===== */
#backBtn{
  position:fixed;
  bottom:20px;
  right:20px;
  background:#00ffc3;
  color:black;
  padding:12px 16px;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  z-index:1200;
  box-shadow:0 0 20px #00ffc355;
}

/* ===== HEADER BUTTONS WIE INDEX ===== */
#logoutBtn{
  position:fixed;
  top:10px;
  right:0;
  background:#ff3b3b;
  color:white;
  padding:8px 12px;
  border-radius:8px 0 0 8px;
  cursor:pointer;
  font-weight:bold;
  display:none;
  z-index:1200;
}

#adminToggle{
  position:fixed;
  top:50px;
  right:0;
  background:#00ffc3;
  color:black;
  padding:8px 12px;
  border-radius:8px 0 0 8px;
  cursor:pointer;
  font-weight:bold;
  display:none;
  z-index:1200;
}

/* Admin Panel */
#adminPanel{
  position:fixed;
  top:90px;
  right:-340px;
  width:300px;
  background:#161616;
  padding:20px;
  border-radius:15px 0 0 15px;
  box-shadow:0 0 25px #00ffc322;
  transition:0.4s;
  z-index:1190;
}
#adminPanel.open{ right:0; }

#adminPanel h3{
  margin:0 0 10px 0;
  text-align:center;
  color:#00ffc3;
}

#adminPanel input{
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:8px;
  border:none;
  background:#222;
  color:white;
}

@media (max-width: 520px){
  #container{ padding-left:14px; padding-right:14px; }
  #topBar{ padding-left:14px; padding-right:14px; }
  .card{ min-width: 100%; flex:1 1 100%; }
}
</style>
</head>

<body>

<div id="topBar">
  <div id="searchWrap">
    <span id="searchIcon">ðŸ”Ž</span>
    <input id="searchBox" placeholder="Fraktion oder Mitglied suchen...">
  </div>
</div>

<div id="container"></div>

<button id="backBtn" onclick="window.location='index.html'">â¬… ZurÃ¼ck</button>
<button id="logoutBtn" onclick="logout()">Logout</button>
<div id="adminToggle">Admin</div>

<div id="adminPanel">
  <h3>Fraktion erstellen</h3>
  <input id="fName" placeholder="Fraktionsname">
  <input id="fColor" type="color" value="#00ffc3">
  <button class="primary" style="width:100%;" onclick="createFraktion()">Erstellen</button>
</div>

<script>
const SUPABASE_URL="https://lleldalugvgmgqekcolx.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsZWxkYWx1Z3ZnbWdxZWtjb2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTg4OTgsImV4cCI6MjA4NzM3NDg5OH0.CuiVJ9kWraso1tLEJ3D6V4IssYGVeWaLs2ygerVU5tc";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let isAdmin=false;
let allFraktionen=[];
let membersByFraktion = new Map();

/* ================= AUTO LOGOUT (60 MIN INAKTIV) ================= */
let inactivityTimer;
function resetInactivityTimer(){
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(()=>{
    alert("Automatischer Logout wegen InaktivitÃ¤t (60 Minuten)");
    logout();
  }, 60*60*1000);
}
document.addEventListener("mousemove", resetInactivityTimer);
document.addEventListener("keydown", resetInactivityTimer);
document.addEventListener("click", resetInactivityTimer);
document.addEventListener("touchstart", resetInactivityTimer);
/* =============================================================== */

window.onload=async()=>{
  const {data}=await db.auth.getSession();
  if(!data.session){ window.location="index.html"; return; }

  document.getElementById("logoutBtn").style.display="block";
  isAdmin = data.session.user.email.toLowerCase()==="admin@gta.local";
  if(isAdmin) document.getElementById("adminToggle").style.display="block";

  resetInactivityTimer();
  await refreshDataAndRender();
  setupRealtime();
};

async function logout(){
  await db.auth.signOut();
  window.location="index.html";
}

async function refreshDataAndRender(){
  const fr = await db.from("fraktionen").select("*");
  if(fr.error){ console.error(fr.error); return; }
  allFraktionen = fr.data || [];

  const mem = await db.from("fraktions_mitglieder").select("*");
  if(mem.error){ console.error(mem.error); return; }

  membersByFraktion = new Map();
  for(const m of (mem.data || [])){
    if(!membersByFraktion.has(m.fraktion_id)) membersByFraktion.set(m.fraktion_id, []);
    membersByFraktion.get(m.fraktion_id).push(m);
  }
  for(const [fid, arr] of membersByFraktion.entries()){
    arr.sort((a,b)=> (a.sort_order ?? 0) - (b.sort_order ?? 0));
  }

  await renderFraktionen(allFraktionen);
}

async function renderFraktionen(list){
  const container=document.getElementById("container");
  container.innerHTML="";

  for(const f of list){
    const members = membersByFraktion.get(f.id) || [];

    const card=document.createElement("div");
    card.className="card";
    card.style.border = "2px solid " + f.color;
    card.style.boxShadow = "0 0 25px " + f.color + "33";

    let html=`<h3 style="color:${f.color}">${escapeHtml(f.name)}</h3>`;
    html+=`<div class="memberList" id="list-${f.id}">`;

    for(const m of members){
      const leaderRowClass = m.leader ? "leaderRow" : "";
      html+=`
        <div class="member ${leaderRowClass}" data-id="${m.id}">
          <div class="memberLeft">
            <span class="leader-star ${m.leader ? 'leader-active' : ''}"
                  title="Leader umschalten"
                  onclick="toggleLeader(event, '${f.id}', '${m.id}', ${m.leader})">â˜…</span>
            <div class="memberName">${escapeHtml(m.vorname)} ${escapeHtml(m.nachname)}</div>
          </div>
          ${isAdmin ? `<button class="delBtn" onclick="deleteMember(event, '${m.id}')">âœ•</button>` : ``}
        </div>
      `;
    }

    html+=`</div>`;

    if(isAdmin){
      html+=`
        <div class="add-form" id="form-${f.id}">
          <input id="vor-${f.id}" placeholder="Vorname" autocomplete="off">
          <input id="nach-${f.id}" placeholder="Nachname" autocomplete="off">
          <button class="primary" onclick="saveMember('${f.id}')">Mitglied speichern</button>
        </div>

        <div class="btnRow">
          <button class="addSoft" onclick="toggleForm('${f.id}')">+ Mitglied</button>
          <button class="dangerSoft" onclick="deleteFraktion('${f.id}')">Fraktion lÃ¶schen</button>
        </div>
      `;
    }

    card.innerHTML=html;
    container.appendChild(card);

    if(isAdmin){
      const vor = card.querySelector(`#vor-${CSS.escape(f.id)}`);
      const nach = card.querySelector(`#nach-${CSS.escape(f.id)}`);
      const handler = (ev)=>{
        if(ev.key === "Enter"){
          ev.preventDefault();
          saveMember(f.id);
        }
      };
      if(vor) vor.addEventListener("keydown", handler);
      if(nach) nach.addEventListener("keydown", handler);

      new Sortable(document.getElementById("list-"+f.id),{
        animation:160,
        onEnd: async ()=>{
          const items=document.querySelectorAll(`#list-${CSS.escape(f.id)} .member`);
          for(let i=0;i<items.length;i++){
            const id = items[i].dataset.id;
            await db.from("fraktions_mitglieder").update({sort_order:i}).eq("id", id);
          }
        }
      });
    }
  }
}

function toggleForm(id){
  const form=document.getElementById("form-"+id);
  if(!form) return;
  const open = (form.style.display==="flex");
  form.style.display = open ? "none" : "flex";
  if(!open){
    const v=document.getElementById("vor-"+id);
    if(v) v.focus();
  }
}

async function createFraktion(){
  const name=document.getElementById("fName").value.trim();
  const color=document.getElementById("fColor").value;
  if(!name) return;
  await db.from("fraktionen").insert([{name,color}]);
  document.getElementById("fName").value="";
}

async function deleteFraktion(id){
  if(!confirm("Fraktion wirklich lÃ¶schen?")) return;
  await db.from("fraktionen").delete().eq("id",id);
}

async function saveMember(fraktion_id){
  const vorEl=document.getElementById("vor-"+fraktion_id);
  const nachEl=document.getElementById("nach-"+fraktion_id);
  if(!vorEl || !nachEl) return;

  const vor=vorEl.value.trim();
  const nach=nachEl.value.trim();
  if(!vor || !nach) return;

  const current = membersByFraktion.get(fraktion_id) || [];
  const next = current.length ? ((current[current.length-1].sort_order ?? (current.length-1)) + 1) : 0;

  await db.from("fraktions_mitglieder").insert([{
    fraktion_id,
    vorname: vor,
    nachname: nach,
    sort_order: next,
    leader: false
  }]);

  vorEl.value="";
  nachEl.value="";
  toggleForm(fraktion_id);
}

async function deleteMember(ev, id){
  ev.stopPropagation();
  await db.from("fraktions_mitglieder").delete().eq("id",id);
}

/* âœ… NUR 1 LEADER PRO FRAKTION */
async function toggleLeader(ev, fraktion_id, member_id, current){
  ev.stopPropagation();

  if(current){
    await db.from("fraktions_mitglieder").update({leader:false}).eq("id", member_id);
    return;
  }
  await db.from("fraktions_mitglieder").update({leader:false}).eq("fraktion_id", fraktion_id);
  await db.from("fraktions_mitglieder").update({leader:true}).eq("id", member_id);
}

/* SEARCH */
document.getElementById("searchBox").addEventListener("input", async (e)=>{
  const q = e.target.value.toLowerCase().trim();
  if(!q){ await renderFraktionen(allFraktionen); return; }

  const filtered = allFraktionen.filter(f=>{
    if((f.name || "").toLowerCase().includes(q)) return true;
    const members = membersByFraktion.get(f.id) || [];
    return members.some(m=>{
      const full = `${m.vorname || ""} ${m.nachname || ""}`.toLowerCase();
      return full.includes(q);
    });
  });

  await renderFraktionen(filtered);
});

/* REALTIME */
function setupRealtime(){
  db.channel("fraktionen-realtime")
    .on("postgres_changes",{event:"*",schema:"public",table:"fraktionen"}, refreshDataAndRender)
    .on("postgres_changes",{event:"*",schema:"public",table:"fraktions_mitglieder"}, refreshDataAndRender)
    .subscribe();
}

document.getElementById("adminToggle").onclick=()=>{
  document.getElementById("adminPanel").classList.toggle("open");
};

function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
</script>
</body>
</html>

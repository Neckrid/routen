<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GTA 5 Interactive Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{ box-sizing:border-box; }

/* ================= PREMIUM BACKGROUND ================= */
body{
  margin:0;
  font-family:Arial;
  color:white;
  overflow:hidden;
  min-height:100vh;

  background:
    radial-gradient(1200px 700px at 12% 18%, rgba(0,255,195,0.10), transparent 60%),
    radial-gradient(900px 650px at 88% 72%, rgba(255,70,180,0.07), transparent 62%),
    radial-gradient(760px 520px at 72% 20%, rgba(0,140,255,0.08), transparent 60%),
    linear-gradient(135deg, #07070b 0%, #0c0c12 45%, #07070b 100%);
}

/* ================= MAP ================= */
#map{
  height:100vh;
  display:none;
}

/* ================= LOGIN ================= */
#loginPanel{
  position:absolute;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  width:min(420px, calc(100vw - 28px));
  padding:22px;
  border-radius:22px;
  z-index:2000;

  background:rgba(22,22,28,0.85);
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);

  box-shadow:
    0 30px 90px rgba(0,0,0,0.65),
    0 0 22px rgba(0,255,195,0.10);
}

#loginPanel h2{
  margin:0 0 14px 0;
  text-align:center;
  color:#00ffc3;
  font-weight:900;
}

#loginPanel input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.06);
  color:white;
  outline:none;
}

#loginBtn{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(0,255,195,0.55);
  background:rgba(0,255,195,0.08);
  color:#00ffc3;
  font-weight:900;
  cursor:pointer;
}
#loginBtn:hover{
  background:rgba(0,255,195,0.14);
}

#msg{
  text-align:center;
  margin-top:10px;
  font-weight:800;
  color:#ffb3b3;
}

/* ================= SEARCH ================= */
#searchBox{
  position:absolute;
  top:10px;
  left:80px;
  z-index:1100;
  display:none;
  width:min(380px, calc(100vw - 160px));
  padding:11px 14px 11px 36px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(22,22,28,0.85);
  color:white;
  backdrop-filter: blur(16px);
}

#searchIcon{
  position:absolute;
  top:10px;
  left:92px;
  z-index:1101;
  display:none;
  color:#00ffc3;
}

/* ================= BUTTONS ================= */
.pillBtn{
  position:fixed;
  right:0;
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 12px;
  border-radius:14px 0 0 14px;
  background:rgba(22,22,28,0.85);
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(16px);
  cursor:pointer;
  z-index:1200;
  height:40px;
}

#logoutBtn{ top:10px; }
#adminToggle{ top:58px; }

/* ================= ADMIN PANEL ================= */
#adminPanel{
  position:fixed;
  top:108px;
  right:0;
  width:320px;
  background:rgba(22,22,28,0.85);
  padding:18px;
  border-radius:18px 0 0 18px;
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(18px);
  box-shadow:0 24px 70px rgba(0,0,0,0.62);
  transform: translateX(106%);
  transition:0.35s ease;
  z-index:1190;
  max-height:calc(100vh - 120px);
  overflow:auto;
  scrollbar-width:none;
}
#adminPanel::-webkit-scrollbar{ display:none; }
#adminPanel.open{ transform:translateX(0); }

.panelLabel{
  font-size:12px;
  font-weight:900;
  margin:10px 0 6px 0;
}

#adminPanel input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.06);
  color:white;
  outline:none;
}

/* Color only */
.colorRow{
  display:flex;
  margin-bottom:10px;
}
.colorRow input[type="color"]{
  width:100%;
  height:42px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:transparent;
  cursor:pointer;
  appearance:none;
  -webkit-appearance:none;
}
.colorRow input[type="color"]::-webkit-color-swatch-wrapper{ padding:0; }
.colorRow input[type="color"]::-webkit-color-swatch{ border:none; border-radius:14px; }

/* Buttons */
.panelBtnRow{
  display:flex;
  gap:10px;
}
.panelBtnRow button{
  flex:1;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.06);
  color:white;
  font-weight:900;
  cursor:pointer;
}

.panelBtnRow .saveBtn{
  border-color:rgba(0,255,195,0.35);
  color:#00ffc3;
}
.panelBtnRow .delBtn{
  border-color:rgba(255,59,59,0.35);
  color:#ff6b6b;
}

.leaflet-div-icon{
  background:transparent !important;
  border:none !important;
}

.leaflet-popup-content-wrapper{
  background:rgba(22,22,28,0.90);
  color:white;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.10);
}
</style>
</head>

<body>

<div id="loginPanel">
  <h2>GTA Map Login</h2>
  <input id="username" placeholder="Benutzername">
  <input id="password" type="password" placeholder="Passwort">
  <button id="loginBtn" onclick="login()">Login</button>
  <p id="msg"></p>
</div>

<div id="searchIcon">ðŸ”Ž</div>
<input id="searchBox" placeholder="Suche...">

<button id="logoutBtn" class="pillBtn" onclick="logout()" style="display:none;">Logout</button>
<div id="adminToggle" class="pillBtn" style="display:none;">Admin</div>

<div id="adminPanel">
  <h3>Marker Verwaltung</h3>

  <div class="panelLabel">Titel</div>
  <input id="mTitle" placeholder="Titel">

  <div class="panelLabel">Beschreibung</div>
  <input id="mDesc" placeholder="Beschreibung">

  <div class="panelLabel">Farbe</div>
  <div class="colorRow">
    <input id="mColor" type="color" value="#ff0000">
  </div>

  <div class="panelBtnRow">
    <button class="saveBtn" onclick="saveMarker()">Speichern</button>
    <button class="delBtn" onclick="deleteMarker()">LÃ¶schen</button>
  </div>
</div>

<div id="coords" style="position:absolute;bottom:15px;left:15px;display:none;"></div>
<div id="map"></div>

<script>
const SUPABASE_URL="https://lleldalugvgmgqekcolx.supabase.co";
const SUPABASE_KEY="DEIN_PUBLIC_KEY";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let map, markerLayer;
let isAdmin=false;
let selectedCoords=null;
let currentEditId=null;
let allMarkers=[];

/* LOGIN */
document.addEventListener("keydown",e=>{ if(e.key==="Enter") login(); });

window.onload=async()=>{
  const {data}=await db.auth.getSession();
  if(data.session){
    isAdmin = ((data.session.user.email || "").toLowerCase() === "admin@gta.local");
    startApp();
  }
};

async function login(){
  const username=document.getElementById("username").value.toLowerCase().trim();
  const password=document.getElementById("password").value;

  const {error}=await db.auth.signInWithPassword({
    email:username+"@gta.local",
    password
  });

  if(error){
    document.getElementById("msg").innerText="Login fehlgeschlagen";
  }else{
    isAdmin = (username==="admin");
    startApp();
  }
}

async function logout(){
  await db.auth.signOut();
  location.reload();
}

/* START */
function startApp(){
  document.getElementById("loginPanel").style.display="none";
  document.getElementById("map").style.display="block";
  document.getElementById("coords").style.display="block";
  document.getElementById("logoutBtn").style.display="flex";
  document.getElementById("searchBox").style.display="block";
  document.getElementById("searchIcon").style.display="block";

  if(isAdmin){
    document.getElementById("adminToggle").style.display="flex";
  }

  initMap();
  loadMarkers();
}

/* MAP */
function initMap(){
  map=L.map('map',{crs:L.CRS.Simple,minZoom:-2,maxZoom:2});
  const bounds=[[0,0],[8192,8192]];
  L.imageOverlay("gta_map.png",bounds).addTo(map);
  map.fitBounds(bounds);
  markerLayer=L.layerGroup().addTo(map);

  map.on("mousemove",e=>{
    document.getElementById("coords").innerText=
      "X:"+Math.round(e.latlng.lng)+" | Y:"+Math.round(e.latlng.lat);
  });

  if(isAdmin){
    map.on("click",e=>{
      selectedCoords=e.latlng;
      currentEditId=null;
    });
  }
}

/* MARKER */
async function loadMarkers(){
  const {data}=await db.from("markers").select("*");
  allMarkers=data || [];
  renderMarkers(allMarkers);
}

function renderMarkers(data){
  markerLayer.clearLayers();
  data.forEach(m=>{
    const icon=L.divIcon({
      html:`<div style="width:22px;height:22px;border-radius:50%;background:${m.color};border:3px solid white;"></div>`,
      className:"",
      iconSize:[28,28],
      iconAnchor:[14,14]
    });

    const marker=L.marker([m.y,m.x],{icon,draggable:isAdmin}).addTo(markerLayer);
    marker.bindPopup("<b>"+(m.title||"")+"</b><br>"+(m.description||""));

    if(isAdmin){
      marker.on("click",()=>{
        currentEditId=m.id;
        document.getElementById("mTitle").value=m.title||"";
        document.getElementById("mDesc").value=m.description||"";
        document.getElementById("mColor").value=m.color||"#ff0000";
        document.getElementById("adminPanel").classList.add("open");
      });

      marker.on("dragend",async e=>{
        const pos=e.target.getLatLng();
        await db.from("markers")
          .update({x:Math.round(pos.lng),y:Math.round(pos.lat)})
          .eq("id",m.id);
      });
    }
  });
}

async function saveMarker(){
  const title=document.getElementById("mTitle").value.trim();
  const description=document.getElementById("mDesc").value.trim();
  const color=document.getElementById("mColor").value;

  if(currentEditId){
    await db.from("markers")
      .update({title,description,color})
      .eq("id",currentEditId);
  }else{
    if(!selectedCoords){ alert("Karte anklicken"); return; }
    await db.from("markers").insert([{
      title,description,color,
      x:Math.round(selectedCoords.lng),
      y:Math.round(selectedCoords.lat)
    }]);
  }
}

async function deleteMarker(){
  if(!currentEditId) return;
  await db.from("markers").delete().eq("id",currentEditId);
}

document.getElementById("searchBox").addEventListener("input",e=>{
  const value=e.target.value.toLowerCase();
  const filtered=allMarkers.filter(m=>
    (m.title||"").toLowerCase().includes(value) ||
    (m.description||"").toLowerCase().includes(value)
  );
  renderMarkers(filtered);
});
</script>
</body>
</html>

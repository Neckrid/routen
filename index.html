<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GTA 5 Interactive Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
 margin:0;
 background:#0e0e0e;
 font-family:Arial;
 color:white;
 overflow:hidden;
}

#map{
 height:100vh;
 display:none;
}

/* LOGIN */
.panel{
 position:absolute;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:#181818;
 padding:30px;
 border-radius:15px;
 width:90%;max-width:400px;
 box-shadow:0 0 25px #00ffc355;
 text-align:center;
}

input{
 width:100%;
 padding:10px;
 margin:8px 0;
 border-radius:8px;
 border:none;
 background:#222;
 color:white;
 font-size:15px;
 box-sizing:border-box;
}

button{
 padding:7px 12px;
 border:none;
 border-radius:8px;
 cursor:pointer;
 font-weight:bold;
 margin-top:6px;
}

.primary{background:#00ffc3;color:black;}
.danger{background:#ff3b3b;color:white;}

#logoutBtn{
 position:absolute;
 top:10px;
 left:50%;
 transform:translateX(-50%);
 display:none;
 font-size:12px;
 padding:5px 10px;
 z-index:1000;
}

/* SEARCH */
#searchBox{
 position:absolute;
 top:10px;
 left:80px;   /* weiter nach rechts */
 z-index:1000;
 display:none;
 width:220px;
}

/* ADMIN PANEL */
#adminPanel{
 position:absolute;
 top:60px;
 right:-320px;
 width:300px;
 background:#161616;
 padding:20px;
 border-radius:15px 0 0 15px;
 box-shadow:0 0 25px #00ffc322;
 transition:0.4s;
 z-index:1000;
}

#adminPanel.open{
 right:0;
}

#adminToggle{
 position:absolute;
 top:60px;
 right:0;
 background:#00ffc3;
 color:black;
 padding:8px 12px;
 border-radius:8px 0 0 8px;
 cursor:pointer;
 font-weight:bold;
 z-index:1100;
 display:none;
}

#adminPanel h3{
 margin-top:0;
 text-align:center;
 color:#00ffc3;
}

.colorPreview{
 width:100%;
 height:20px;     /* d√ºnner */
 border-radius:6px;
 margin-top:5px;
 margin-bottom:12px;  /* Abstand zum Button */
 border:2px solid white;
}

#coords{
 position:absolute;
 bottom:15px;
 left:15px;
 background:#000000aa;
 padding:8px 14px;
 border-radius:8px;
 font-size:14px;
 display:none;
 z-index:1000;
}

.leaflet-div-icon{
 background:transparent !important;
 border:none !important;
}
</style>
</head>

<body>

<div id="loginPanel" class="panel">
<h2>GTA Map Login</h2>
<input id="username" placeholder="Benutzername">
<input id="password" type="password" placeholder="Passwort">
<button class="primary" onclick="login()">Login</button>
<p id="msg"></p>
</div>

<button id="logoutBtn" class="danger" onclick="logout()">Logout</button>
<input id="searchBox" placeholder="üîé Suche...">

<div id="adminToggle">Admin</div>

<div id="adminPanel">
<h3>Admin Panel</h3>
<input id="mTitle" placeholder="Titel">
<input id="mDesc" placeholder="Beschreibung">
<input id="mColor" type="color" value="#ff0000" onchange="updateColorPreview()">
<div id="colorPreview" class="colorPreview"></div>
<button class="primary" onclick="createMarker()">Marker erstellen</button>
</div>

<div id="coords"></div>
<div id="map"></div>

<script>

const SUPABASE_URL="https://lleldalugvgmgqekcolx.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsZWxkYWx1Z3ZnbWdxZWtjb2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTg4OTgsImV4cCI6MjA4NzM3NDg5OH0.CuiVJ9kWraso1tLEJ3D6V4IssYGVeWaLs2ygerVU5tc";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let map,markerLayer,isAdmin=false,selectedCoords=null,allMarkers=[];

document.addEventListener("keydown",e=>{
 if(e.key==="Enter") login();
});

window.onload=async()=>{
 const {data}=await db.auth.getSession();
 if(data.session){
  isAdmin=data.session.user.email==="admin@gta.local";
  startApp();
 }
};

async function login(){
 const username=document.getElementById("username").value;
 const password=document.getElementById("password").value;

 const {error}=await db.auth.signInWithPassword({
  email:username+"@gta.local",
  password
 });

 if(error){
  document.getElementById("msg").innerText="Login fehlgeschlagen";
 }else{
  isAdmin=username==="admin";
  startApp();
 }
}

async function logout(){
 await db.auth.signOut();
 location.reload();
}

function startApp(){
 document.getElementById("loginPanel").style.display="none";
 document.getElementById("map").style.display="block";
 document.getElementById("coords").style.display="block";
 document.getElementById("logoutBtn").style.display="block";
 document.getElementById("searchBox").style.display="block";

 if(isAdmin){
  document.getElementById("adminToggle").style.display="block";
 }

 initMap();
 loadMarkers();
 updateColorPreview();
}

function initMap(){
 map=L.map('map',{crs:L.CRS.Simple,minZoom:-2,maxZoom:2});
 const bounds=[[0,0],[8192,8192]];
 L.imageOverlay("gta_map.png",bounds).addTo(map);
 map.fitBounds(bounds);

 markerLayer=L.layerGroup().addTo(map);

 map.on("mousemove",e=>{
  document.getElementById("coords").innerText=
   "X:"+Math.round(e.latlng.lng)+" | Y:"+Math.round(e.latlng.lat);
 });

 if(isAdmin){
  map.on("click",e=>{
   selectedCoords=e.latlng;
   document.getElementById("mTitle").focus();
  });
 }
}

async function loadMarkers(){
 const {data}=await db.from("markers").select("*");
 allMarkers=data;
 renderMarkers(data);
}

function renderMarkers(data){
 markerLayer.clearLayers();

 data.forEach(m=>{
  const icon=L.divIcon({
   html:`<div style="
    background:${m.color};
    width:22px;height:22px;
    border-radius:50%;
    border:3px solid white;
    box-shadow:0 0 10px ${m.color};"></div>`
  });

  const marker=L.marker([m.y,m.x],{
   icon,
   draggable:isAdmin
  }).addTo(markerLayer);

  marker.on("dragend",async e=>{
   if(!isAdmin) return;
   const pos=e.target.getLatLng();
   await db.from("markers")
    .update({x:Math.round(pos.lng),y:Math.round(pos.lat)})
    .eq("id",m.id);
  });

  let popup="<b>"+m.title+"</b><br>"+m.description;

  if(isAdmin){
   popup+=`
   <br><button onclick="editMarker(${m.id})">Bearbeiten</button>
   <button onclick="deleteMarker(${m.id})">L√∂schen</button>
   `;
  }

  marker.bindPopup(popup);
 });
}

/* SEARCH */
document.getElementById("searchBox").addEventListener("input",e=>{
 const value=e.target.value.toLowerCase();
 const filtered=allMarkers.filter(m=>
  m.title.toLowerCase().includes(value) ||
  m.description.toLowerCase().includes(value)
 );
 renderMarkers(filtered);
});

/* ADMIN PANEL TOGGLE */
document.getElementById("adminToggle").onclick=()=>{
 document.getElementById("adminPanel").classList.toggle("open");
};

function updateColorPreview(){
 const color=document.getElementById("mColor").value;
 document.getElementById("colorPreview").style.background=color;
}

async function createMarker(){
 if(!selectedCoords){
  alert("Klicke zuerst auf die Karte");
  return;
 }

 const title=document.getElementById("mTitle").value;
 const description=document.getElementById("mDesc").value;
 const color=document.getElementById("mColor").value;

 await db.from("markers").insert([{
  title,description,color,
  x:Math.round(selectedCoords.lng),
  y:Math.round(selectedCoords.lat)
 }]);

 loadMarkers();
}

async function editMarker(id){
 const {data}=await db.from("markers").select("*").eq("id",id).single();

 const title=prompt("Titel:",data.title);
 const description=prompt("Beschreibung:",data.description);
 const color=prompt("Farbe:",data.color);

 await db.from("markers")
  .update({title,description,color})
  .eq("id",id);

 loadMarkers();
}

async function deleteMarker(id){
 if(!confirm("Wirklich l√∂schen?")) return;
 await db.from("markers").delete().eq("id",id);
 loadMarkers();
}

</script>
</body>
</html>

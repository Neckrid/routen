<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GTA 5 Interactive Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{
 margin:0;
 background:#0e0e0e;
 font-family:Arial;
 color:white;
 overflow:hidden;
}

#map{height:100vh;display:none;}

.panel{
 position:absolute;
 top:50%;left:50%;
 transform:translate(-50%,-50%);
 background:#181818;
 padding:30px;
 border-radius:15px;
 width:90%;max-width:400px;
 box-shadow:0 0 25px #00ffc355;
 text-align:center;
}

input{
 width:100%;
 padding:10px;
 margin:8px 0;
 border-radius:8px;
 border:none;
 background:#222;
 color:white;
 box-sizing:border-box;
}

button{
 padding:8px 14px;
 border:none;
 border-radius:8px;
 cursor:pointer;
 font-weight:bold;
}

/* SEARCH */
#searchBox{
 position:absolute;
 top:10px;
 left:80px;
 z-index:1100;
 display:none;
 width:220px;
}

/* LOGOUT */
#logoutBtn{
 position:absolute;
 top:10px;
 right:0;
 background:#ff3b3b;
 color:white;
 padding:8px 12px;
 border-radius:8px 0 0 8px;
 cursor:pointer;
 font-weight:bold;
 display:none;
 z-index:1200;
}

/* ADMIN TOGGLE */
#adminToggle{
 position:absolute;
 top:50px;
 right:0;
 background:#00ffc3;
 color:black;
 padding:8px 12px;
 border-radius:8px 0 0 8px;
 cursor:pointer;
 font-weight:bold;
 z-index:1100;
 display:none;
}

/* ADMIN PANEL (komplett versteckt via transform) */
#adminPanel{
 position:absolute;
 top:90px;
 right:0;
 width:300px;
 background:#161616;
 padding:20px;
 border-radius:15px 0 0 15px;
 box-shadow:0 0 25px #00ffc322;
 transition:transform 0.4s ease;
 z-index:1000;
 transform:translateX(100%);
}
#adminPanel.open{ transform:translateX(0); }

#adminPanel h3{
 margin-top:0;
 text-align:center;
 color:#00ffc3;
}

/* Koordinaten-Status */
#coordBadge{
 margin:10px 0 14px 0;
 padding:10px 12px;
 border-radius:10px;
 font-size:13px;
 line-height:1.25;
 background:#0b0b0b;
 border:1px solid #2a2a2a;
 color:#cfcfcf;
 box-shadow:inset 0 0 0 1px #000;
}
#coordBadge.ready{
 border-color:#00ffc355;
 color:#00ffc3;
 box-shadow:0 0 12px #00ffc322, inset 0 0 0 1px #000;
}
#coordBadge.editing{
 border-color:#ffcc0033;
 color:#ffcc00;
 box-shadow:0 0 12px #ffcc0022, inset 0 0 0 1px #000;
}
#coordBadge b{ color:white; }

.colorPreview{
 width:100%;
 height:20px;
 border-radius:6px;
 margin-top:5px;
 margin-bottom:12px;
 border:2px solid white;
}

.primary{background:#00ffc3;color:black;}
.danger{background:#ff3b3b;color:white;}

#coords{
 position:absolute;
 bottom:15px;
 left:15px;
 background:#000000aa;
 padding:8px 14px;
 border-radius:8px;
 font-size:14px;
 display:none;
 z-index:1000;
}

#fraktionenBtn{
 position:absolute;
 bottom:20px;
 right:20px;
 background:#00ffc3;
 color:black;
 padding:12px 16px;
 border-radius:12px;
 font-weight:bold;
 cursor:pointer;
 z-index:1200;
 box-shadow:0 0 20px #00ffc355;
 display:none;
}

.leaflet-div-icon{
 background:transparent !important;
 border:none !important;
}

/* ‚úÖ Icon Picker */
.iconPickerTitle{
 margin:10px 0 6px 0;
 font-size:13px;
 color:#bfbfbf;
}
.iconPicker{
 display:flex;
 gap:10px;
 margin:0 0 10px 0;
}
.iconPick{
 flex:1;
 display:flex;
 align-items:center;
 justify-content:center;
 gap:8px;
 padding:10px 10px;
 border-radius:12px;
 cursor:pointer;
 user-select:none;
 background:#111;
 border:1px solid #2a2a2a;
 color:#eaeaea;
}
.iconPick svg{
 width:22px;
 height:22px;
 display:block;
}
.iconPick.active{
 border-color:#00ffc355;
 box-shadow:0 0 14px #00ffc322;
}
.iconPick small{
 opacity:.9;
 font-weight:bold;
 letter-spacing:.2px;
}
</style>
</head>

<body>

<div id="loginPanel" class="panel">
<h2>GTA Map Login</h2>
<input id="username" placeholder="Benutzername">
<input id="password" type="password" placeholder="Passwort">
<button class="primary" onclick="login()">Login</button>
<p id="msg"></p>
</div>

<button id="logoutBtn" onclick="logout()">Logout</button>
<input id="searchBox" placeholder="üîé Suche...">
<div id="adminToggle">Admin</div>

<div id="adminPanel">
<h3>Marker Verwaltung</h3>

<div id="coordBadge">üñ±Ô∏è <b>Keine Koordinate gew√§hlt</b><br>Klicke in die Karte, um einen neuen Marker zu platzieren.</div>

<input id="mTitle" placeholder="Titel">
<input id="mDesc" placeholder="Beschreibung">

<!-- ‚úÖ Icon Auswahl -->
<div class="iconPickerTitle">Icon (optional)</div>
<div class="iconPicker">
  <div class="iconPick active" id="pickDot" onclick="setIcon('')">
    <div style="width:16px;height:16px;border-radius:50%;border:2px solid #fff;background:#666;box-shadow:0 0 10px #666;"></div>
    <small>Punkt</small>
  </div>

  <div class="iconPick" id="pickHouse" onclick="setIcon('house')">
    <!-- House SVG -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path fill="currentColor" d="M12 3.2 3 10.2v10.2c0 .9.7 1.6 1.6 1.6H9.8v-6.3c0-.7.5-1.2 1.2-1.2h2c.7 0 1.2.5 1.2 1.2V22h5.2c.9 0 1.6-.7 1.6-1.6V10.2L12 3.2z"/>
    </svg>
    <small>Haus</small>
  </div>

  <div class="iconPick" id="pickLab" onclick="setIcon('lab')">
    <!-- Flask / Lab SVG -->
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path fill="currentColor" d="M9 2h6v2h-1v5.1l4.9 8.5c1 1.7-.2 3.4-2.1 3.4H7.2c-1.9 0-3.1-1.7-2.1-3.4L10 9.1V4H9V2zm2.2 8.1-4.4 7.6c-.2.4.1.8.4.8h9.6c.4 0 .7-.4.4-.8l-4.4-7.6V4h-1.6v6.1z"/>
    </svg>
    <small>Labor</small>
  </div>
</div>

<input id="mColor" type="color" value="#ff0000" onchange="updateColorPreview()">
<div id="colorPreview" class="colorPreview"></div>

<button class="primary" onclick="saveMarker()">Speichern</button>
<button class="danger" onclick="deleteMarker()">L√∂schen</button>
</div>

<div id="coords"></div>
<div id="map"></div>

<button id="fraktionenBtn" onclick="window.location='fraktionen.html'">
üè¥ Fraktionen
</button>

<script>
const SUPABASE_URL="https://lleldalugvgmgqekcolx.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsZWxkYWx1Z3ZnbWdxZWtjb2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTg4OTgsImV4cCI6MjA4NzM3NDg5OH0.CuiVJ9kWraso1tLEJ3D6V4IssYGVeWaLs2ygerVU5tc";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let map,markerLayer,isAdmin=false,selectedCoords=null,currentEditId=null,allMarkers=[];
let inactivityTimer;

// ‚úÖ Icon state ("" = Punkt)
let selectedIcon = "";

/* ================= AUTO LOGOUT ================= */
function resetInactivityTimer(){
 clearTimeout(inactivityTimer);
 inactivityTimer=setTimeout(()=>{
  alert("Automatischer Logout wegen Inaktivit√§t (60 Minuten)");
  logout();
 },60*60*1000);
}
document.addEventListener("mousemove",resetInactivityTimer);
document.addEventListener("keydown",resetInactivityTimer);
document.addEventListener("click",resetInactivityTimer);
document.addEventListener("touchstart",resetInactivityTimer);

/* ================= LOGIN ================= */
document.addEventListener("keydown",e=>{
 if(e.key==="Enter") login();
});

window.onload=async()=>{
 const {data}=await db.auth.getSession();
 if(data.session){
  isAdmin=data.session.user.email.toLowerCase()==="admin@gta.local";
  startApp();
 }
};

async function login(){
 const usernameRaw=document.getElementById("username").value;
 const username=usernameRaw.toLowerCase();
 const password=document.getElementById("password").value;

 const {error}=await db.auth.signInWithPassword({
  email:username+"@gta.local",
  password
 });

 if(error){
  document.getElementById("msg").innerText="Login fehlgeschlagen";
 }else{
  isAdmin=username==="admin";
  startApp();
 }
}

async function logout(){
 await db.auth.signOut();
 location.reload();
}

/* ================= START ================= */
function startApp(){
 document.getElementById("loginPanel").style.display="none";
 document.getElementById("map").style.display="block";
 document.getElementById("coords").style.display="block";
 document.getElementById("logoutBtn").style.display="block";
 document.getElementById("searchBox").style.display="block";
 document.getElementById("fraktionenBtn").style.display="block";

 if(isAdmin){
  document.getElementById("adminToggle").style.display="block";
 }

 initMap();
 loadMarkers();
 setupRealtime();
 updateColorPreview();
 updateCoordBadge();
 resetInactivityTimer();
}

/* ================= COORD BADGE ================= */
function updateCoordBadge(mode){
 const badge=document.getElementById("coordBadge");
 badge.classList.remove("ready","editing");

 if(mode==="editing"){
  badge.classList.add("editing");
  badge.innerHTML="‚úèÔ∏è <b>Bearbeiten-Modus</b><br>Du bearbeitest einen bestehenden Marker.";
  return;
 }

 if(selectedCoords){
  badge.classList.add("ready");
  badge.innerHTML=
   "‚úÖ <b>Koordinate gew√§hlt</b><br>" +
   "X: "+Math.round(selectedCoords.lng)+" &nbsp; | &nbsp; Y: "+Math.round(selectedCoords.lat);
 }else{
  badge.innerHTML="üñ±Ô∏è <b>Keine Koordinate gew√§hlt</b><br>Klicke in die Karte, um einen neuen Marker zu platzieren.";
 }
}

/* ================= ICON PICKER ================= */
function setIcon(icon){
 selectedIcon = icon || "";
 document.getElementById("pickDot").classList.toggle("active", selectedIcon==="");
 document.getElementById("pickHouse").classList.toggle("active", selectedIcon==="house");
 document.getElementById("pickLab").classList.toggle("active", selectedIcon==="lab");
}

function setIconFromMarker(icon){
 setIcon(icon || "");
}

/* ================= MAP ================= */
function initMap(){
 map=L.map('map',{crs:L.CRS.Simple,minZoom:-2,maxZoom:2});
 const bounds=[[0,0],[8192,8192]];
 L.imageOverlay("gta_map.png",bounds).addTo(map);
 map.fitBounds(bounds);

 markerLayer=L.layerGroup().addTo(map);

 map.on("mousemove",e=>{
  document.getElementById("coords").innerText=
   "X:"+Math.round(e.latlng.lng)+" | Y:"+Math.round(e.latlng.lat);
 });

 if(isAdmin){
  map.on("click",e=>{
   clearForm();
   selectedCoords=e.latlng;
   currentEditId=null;

   document.getElementById("adminPanel").classList.add("open");
   updateCoordBadge();
  });
 }
}

/* ================= MARKER ICON HTML ================= */
function markerIconHTML(color, icon){
 const safeColor = color || "#ff0000";

 if(icon==="house"){
  return `
   <div style="
     width:42px;
     height:42px;
     display:flex;
     align-items:center;
     justify-content:center;
     transform: translate(-13px,-13px);
   ">
     <svg viewBox="0 0 24 24" width="42" height="42" style="
       color:${safeColor};
     ">
       <path fill="currentColor"
        d="M12 3.2 3 10.2v10.2c0 .9.7 1.6 1.6 1.6H9.8v-6.3c0-.7.5-1.2 1.2-1.2h2c.7 0 1.2.5 1.2 1.2V22h5.2c.9 0 1.6-.7 1.6-1.6V10.2L12 3.2z"/>
     </svg>
   </div>`;
 }

 if(icon==="lab"){
  return `
   <div style="
     width:42px;
     height:42px;
     display:flex;
     align-items:center;
     justify-content:center;
     transform: translate(-13px,-13px);
   ">
     <svg viewBox="0 0 24 24" width="42" height="42" style="
       color:${safeColor};
     ">
       <!-- Ausgef√ºlltes Labor Icon -->
       <path fill="currentColor"
        d="M9 2h6v2h-1v5l5 8.5c1 1.7-.2 3.5-2.2 3.5H7.2c-2 0-3.2-1.8-2.2-3.5L10 9V4H9V2z"/>
     </svg>
   </div>`;
 }

 // Default Punkt
 return `<div style="
    background:${safeColor};
    width:22px;height:22px;
    border-radius:50%;
    border:3px solid white;
    box-shadow:0 0 10px ${safeColor};"></div>`;
}

/* ================= MARKER ================= */
async function loadMarkers(){
 const {data}=await db.from("markers").select("*");
 allMarkers=data || [];
 renderMarkers(allMarkers);
}

function renderMarkers(data){
 markerLayer.clearLayers();

 data.forEach(m=>{
  const icon=L.divIcon({
   html: markerIconHTML(m.color, m.icon),
   className: "" // wichtig: Leaflet default styles aus
  });

  const marker=L.marker([m.y,m.x],{
   icon,
   draggable:isAdmin
  }).addTo(markerLayer);

  if(isAdmin){
   marker.on("click",()=>{
    selectedCoords=null; // kein Insert mit alten Koords

    currentEditId=m.id;
    document.getElementById("mTitle").value=m.title || "";
    document.getElementById("mDesc").value=m.description || "";
    document.getElementById("mColor").value=m.color || "#ff0000";
    updateColorPreview();

    setIconFromMarker(m.icon);

    document.getElementById("adminPanel").classList.add("open");
    updateCoordBadge("editing");
   });

   marker.on("dragend",async e=>{
    const pos=e.target.getLatLng();
    await db.from("markers")
     .update({x:Math.round(pos.lng),y:Math.round(pos.lat)})
     .eq("id",m.id);
   });
  }

  marker.bindPopup("<b>"+(m.title||"")+"</b><br>"+(m.description||""));
 });
}

async function saveMarker(){
 const title=document.getElementById("mTitle").value.trim();
 const description=document.getElementById("mDesc").value.trim();
 const color=document.getElementById("mColor").value;
 const icon = selectedIcon || null; // null => Punkt

 if(!title){ alert("Titel fehlt"); return; }

 if(currentEditId){
  await db.from("markers")
   .update({title,description,color,icon})
   .eq("id",currentEditId);

  clearForm();
  updateCoordBadge();
 }else{
  if(!selectedCoords){ alert("Karte anklicken"); return; }

  await db.from("markers").insert([{
   title,description,color,icon,
   x:Math.round(selectedCoords.lng),
   y:Math.round(selectedCoords.lat)
  }]);

  clearForm();
  selectedCoords=null;
  updateCoordBadge();
 }
}

async function deleteMarker(){
 if(!currentEditId) return;
 await db.from("markers").delete().eq("id",currentEditId);
 clearForm();
 selectedCoords=null;
 updateCoordBadge();
}

function clearForm(){
 document.getElementById("mTitle").value="";
 document.getElementById("mDesc").value="";
 currentEditId=null;

 // Default wieder Punkt
 setIcon("");
}

/* SEARCH */
document.getElementById("searchBox").addEventListener("input",e=>{
 const value=e.target.value.toLowerCase();
 const filtered=allMarkers.filter(m=>
  (m.title||"").toLowerCase().includes(value) ||
  (m.description||"").toLowerCase().includes(value)
 );
 renderMarkers(filtered);
});

/* REALTIME */
function setupRealtime(){
 db.channel("realtime-markers")
  .on("postgres_changes",
   {event:"*",schema:"public",table:"markers"},
   ()=>loadMarkers()
  ).subscribe();
}

document.getElementById("adminToggle").onclick=()=>{
 document.getElementById("adminPanel").classList.toggle("open");
};

function updateColorPreview(){
 document.getElementById("colorPreview").style.background=
  document.getElementById("mColor").value;

 // Optional: Punkt-Preview Farbe passend machen (nur optisch)
 const dot = document.querySelector("#pickDot > div");
 if(dot){
  dot.style.background = document.getElementById("mColor").value;
  dot.style.boxShadow = "0 0 10px " + document.getElementById("mColor").value;
 }
}
</script>
</body>
</html>

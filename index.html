<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>GTA 5 Interactive Map</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{ box-sizing:border-box; }

/* ================= PREMIUM BACKGROUND ================= */
body{
  margin:0;
  font-family:Arial;
  color:white;
  overflow:hidden;
  min-height:100vh;

  background:
    radial-gradient(1200px 700px at 12% 18%, rgba(0,255,195,0.10), transparent 60%),
    radial-gradient(900px 650px at 88% 72%, rgba(255,70,180,0.07), transparent 62%),
    radial-gradient(760px 520px at 72% 20%, rgba(0,140,255,0.08), transparent 60%),
    linear-gradient(135deg, #07070b 0%, #0c0c12 45%, #07070b 100%);
}
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:1;
  opacity:0.16;
  background:
    linear-gradient(to right, rgba(255,255,255,0.035) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(255,255,255,0.028) 1px, transparent 1px);
  background-size: 64px 64px;
  mask-image: radial-gradient(circle at 50% 30%, rgba(0,0,0,1), rgba(0,0,0,0.0) 68%);
}
body::after{
  content:"";
  position:fixed;
  inset:-20%;
  pointer-events:none;
  z-index:2;
  background:
    radial-gradient(700px 520px at 18% 30%, rgba(0,255,195,0.12), transparent 65%),
    radial-gradient(680px 520px at 78% 66%, rgba(0,140,255,0.10), transparent 65%),
    radial-gradient(520px 420px at 64% 18%, rgba(255,70,180,0.07), transparent 65%);
  filter: blur(22px);
  opacity:0.70;
  animation: bgFloat 14s ease-in-out infinite alternate;
  transform: translate3d(0,0,0);
}
@keyframes bgFloat{
  0%   { transform: translate3d(-1.5%, -1%, 0) scale(1.02); }
  50%  { transform: translate3d(1.2%, 0.8%, 0) scale(1.03); }
  100% { transform: translate3d(-0.8%, 1.2%, 0) scale(1.02); }
}
html::after{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:3;
  opacity:0.06;
  mix-blend-mode:overlay;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.4'/%3E%3C/svg%3E");
}

/* Map */
#map{height:100vh;display:none;position:relative;z-index:10;}

/* ================= GLASS ================= */
.glass{
  background:rgba(22,22,28,0.84);
  border:1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(16px);
  -webkit-backdrop-filter: blur(16px);
  box-shadow:
    0 18px 55px rgba(0,0,0,0.55),
    0 0 0 1px rgba(255,255,255,0.05) inset;
}

/* ================= LOGIN ================= */
#loginPanel{
  position:absolute;
  top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:min(420px, calc(100vw - 28px));
  padding:22px;
  border-radius:22px;
  z-index:2000;
}
#loginPanel h2{
  margin:0 0 14px 0;
  text-align:center;
  color:#00ffc3;
  font-weight:900;
  letter-spacing:0.3px;
}
#loginPanel input{
  width:100%;
  padding:12px;
  margin:0 0 10px 0;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:rgba(255,255,255,0.06);
  color:white;
  outline:none;
}
#loginPanel input::placeholder{ color:rgba(255,255,255,0.5); font-weight:800; }
#loginPanel input:focus{
  border-color: rgba(0,255,195,0.55);
  box-shadow: 0 0 0 3px rgba(0,255,195,0.12);
}
#loginBtn{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(0,255,195,0.55);
  background:rgba(0,255,195,0.10);
  color:#00ffc3;
  font-weight:900;
  cursor:pointer;
  transition:.15s ease;
}
#loginBtn:hover{ transform:translateY(-1px); background:rgba(0,255,195,0.14); }
#loginBtn:active{ transform:scale(0.99); }
#msg{
  margin:10px 0 0 0;
  text-align:center;
  font-weight:800;
  opacity:0.9;
  color:#ffb3b3;
}

/* ================= SEARCH (Position bleibt) ================= */
.searchWrapper{
  position:absolute;
  top:10px;
  left:80px;
  z-index:1100;
  display:none;
  /* ‚úÖ wichtig: Icon relativ zur Box */
  position:absolute;
}
.searchInner{
  position:relative; /* ‚úÖ Icon sitzt relativ zum Input */
}
#searchBox{
  width:min(380px, calc(100vw - 160px));
  height:42px;
  padding:0 14px 0 40px;
  border-radius:14px;
  border:none;
  outline:none;
  color:rgba(255,255,255,0.92);
}
#searchBox::placeholder{ color:rgba(255,255,255,0.55); font-weight:900; }
#searchIcon{
  position:absolute;
  left:14px;
  top:50%;
  transform:translateY(-50%);
  z-index:2;
  pointer-events:none;
  color:#00ffc3;
  opacity:0.95;
  font-size:14px;
  text-shadow:0 2px 10px rgba(0,0,0,0.55);
}

/* ====== Right pills ====== */
:root{
  --edge-gap: 0px;
  --btn-gap: 8px;
  --btn-h: 40px;
  --btn-top: 10px;
}
.pillBtn{
  position:fixed;
  right:var(--edge-gap);
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;

  padding:8px 10px;
  border-radius:14px 0 0 14px;
  font-size:13px;

  cursor:pointer;
  z-index:1200;
  transition:0.18s ease;
  user-select:none;
  height:var(--btn-h);
}
.pillBtn:hover{
  transform: translateY(-1px);
  border-color: rgba(255,255,255,0.16);
  box-shadow:
    0 18px 46px rgba(0,0,0,0.50),
    inset 0 0 0 1px rgba(255,255,255,0.06);
}
.pillBtn:active{ transform: scale(0.99); transition:0.06s ease; }

.pillIcon{
  width:24px;
  height:24px;
  border-radius:9px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:13px;
  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.10);
}

#logoutBtn{ top:var(--btn-top); color:#ffb3b3; border-color: rgba(255,59,59,0.35); }
#logoutBtn .pillIcon{ background:rgba(255,59,59,0.10); border-color: rgba(255,59,59,0.20); }
#logoutBtn:hover{ box-shadow:0 18px 46px rgba(0,0,0,0.50), 0 0 26px rgba(255,59,59,0.10), inset 0 0 0 1px rgba(255,59,59,0.12); color:#fff; }

#adminToggle{ top:calc(var(--btn-top) + var(--btn-h) + var(--btn-gap)); color:#00ffc3; border-color: rgba(0,255,195,0.35); }
#adminToggle .pillIcon{ background:rgba(0,255,195,0.10); border-color: rgba(0,255,195,0.20); }
#adminToggle:hover{ box-shadow:0 18px 46px rgba(0,0,0,0.50), 0 0 26px rgba(0,255,195,0.10), inset 0 0 0 1px rgba(0,255,195,0.12); }

/* Fraktionen */
#fraktionenBtn{
  position:fixed;
  bottom:18px;
  right:18px;
  padding:12px 14px;
  border-radius:16px;

  border:1px solid rgba(0,255,195,0.35);
  color:#00ffc3;

  z-index:1200;
  transition:0.18s ease;
  display:none;
  font-weight:900;
  cursor:pointer;
}
#fraktionenBtn:hover{
  transform: translateY(-1px);
  box-shadow:
    0 20px 52px rgba(0,0,0,0.58),
    0 0 30px rgba(0,255,195,0.14),
    inset 0 0 0 1px rgba(0,255,195,0.12);
}
#fraktionenBtn:active{ transform: scale(0.99); transition:0.06s ease; }

/* Coords */
#coords{
  position:absolute;
  bottom:15px;
  left:15px;
  padding:8px 14px;
  border-radius:12px;
  font-size:14px;
  display:none;
  z-index:1000;
}

/* ================= ADMIN PANEL ================= */
#adminPanel{
  position:fixed;
  top:calc(var(--btn-top) + (var(--btn-h) + var(--btn-gap)) * 2);
  right:var(--edge-gap);
  width:320px;

  padding:18px;
  border-radius:18px 0 0 18px;

  transform: translateX(106%);
  transition:0.35s ease;
  z-index:1190;

  max-height: calc(100vh - (var(--btn-top) + (var(--btn-h) + var(--btn-gap)) * 2) - 14px);
  overflow:auto;
  scrollbar-width:none;
}
#adminPanel::-webkit-scrollbar{ width:0; height:0; }
#adminPanel.open{ transform: translateX(0); }

#adminPanel h3{
  margin:0 0 10px 0;
  text-align:center;
  color:#00ffc3;
  font-weight:900;
  letter-spacing:0.25px;
}

.panelLabel{
  font-size:12px;
  opacity:0.78;
  font-weight:900;
  letter-spacing:0.18px;
  margin:10px 0 6px 0;
}

#adminPanel input{
  width:100%;
  padding:12px 12px;
  margin:0 0 10px 0;
  border-radius:14px;
  border:none;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  color:rgba(255,255,255,0.92);
  outline:none;
}
#adminPanel input::placeholder{ color:rgba(255,255,255,0.5); font-weight:900; }
#adminPanel input:focus{
  border-color: rgba(0,255,195,0.55);
  box-shadow: 0 0 0 3px rgba(0,255,195,0.12);
}

/* Coord badge */
#coordBadge{
  margin:10px 0 14px 0;
  padding:14px 16px;
  border-radius:16px;
  font-size:13px;
  line-height:1.4;
  display:flex;
  flex-direction:column;
  gap:4px;

  background:rgba(255,255,255,0.05);
  border:1px solid rgba(255,255,255,0.12);
  transition:0.2s ease;
}
#coordBadge b{
  font-weight:900;
  font-size:14px;
  letter-spacing:0.2px;
  color:white;
}
#coordBadge.ready{
  border-color: rgba(0,255,195,0.45);
  background: linear-gradient(145deg, rgba(0,255,195,0.10), rgba(0,255,195,0.05));
  box-shadow: 0 0 22px rgba(0,255,195,0.08);
  color:#00ffc3;
}
#coordBadge.editing{
  border-color: rgba(255,213,74,0.55);
  background: linear-gradient(145deg, rgba(255,213,74,0.12), rgba(255,213,74,0.05));
  box-shadow: 0 0 22px rgba(255,213,74,0.08);
  color:#ffd54a;
}

/* Icon picker */
.iconPickerTitle{
  margin:10px 0 6px 0;
  font-size:12px;
  opacity:0.78;
  font-weight:900;
  letter-spacing:0.18px;
}
.iconPicker{
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
  margin:0 0 10px 0;
}
.iconPick{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:8px;
  padding:10px 10px;
  border-radius:14px;
  cursor:pointer;
  user-select:none;

  background:linear-gradient(145deg, rgba(255,255,255,0.06), rgba(0,0,0,0.22));
  border:1px solid rgba(255,255,255,0.10);
  color:rgba(255,255,255,0.92);
  box-shadow:
    0 10px 24px rgba(0,0,0,0.35),
    inset 0 0 0 1px rgba(255,255,255,0.04);
  transition:0.18s ease;
}
.iconPick:hover{ transform: translateY(-1px); }
.iconPick:active{ transform: scale(0.99); transition:0.06s ease; }
.iconPick svg{ width:20px; height:20px; display:block; opacity:0.95; }
.iconPick small{ font-weight:900; letter-spacing:.2px; opacity:.95; }
.iconPick.active{
  border-color: rgba(0,255,195,0.35);
  box-shadow:
    0 14px 34px rgba(0,0,0,0.42),
    0 0 22px rgba(0,255,195,0.10),
    inset 0 0 0 1px rgba(0,255,195,0.10);
}

/* Color row (no preview box) */
.colorRow{
  display:flex;
  align-items:center;
  margin-bottom:10px;
}
.colorRow input[type="color"]{
  width:100%;
  height:42px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.12);
  background:transparent;
  padding:0;
  cursor:pointer;
  overflow:hidden;
  appearance:none;
  -webkit-appearance:none;
}
.colorRow input[type="color"]::-webkit-color-swatch-wrapper{ padding:0; }
.colorRow input[type="color"]::-webkit-color-swatch{ border:none; border-radius:14px; }

/* Save/Delete */
.panelBtnRow{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.panelBtnRow button{
  flex:1;
  padding:12px 12px;
  border-radius:14px;
  font-weight:900;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.12);
  color:white;
  cursor:pointer;
  transition:0.15s ease;
}
.panelBtnRow button:hover{ transform: translateY(-1px); }
.panelBtnRow button:active{ transform: scale(0.985); }
.panelBtnRow .saveBtn{ color:#00ffc3; border-color: rgba(0,255,195,0.35); }
.panelBtnRow .delBtn{ color:#ff6b6b; border-color: rgba(255,59,59,0.35); }

/* Leaflet divIcon defaults neutralisieren */
.leaflet-div-icon{ background:transparent !important; border:none !important; }

/* Popup premium */
.leaflet-popup-content-wrapper{
  background:rgba(22,22,28,0.90);
  color:white;
  border-radius:14px;
  border:1px solid rgba(255,255,255,0.10);
  box-shadow:0 18px 55px rgba(0,0,0,0.55);
  backdrop-filter: blur(12px);
}
.leaflet-popup-tip{ background:rgba(22,22,28,0.90); }
</style>
</head>

<body>

<div id="loginPanel" class="glass">
  <h2>GTA Map Login</h2>
  <input id="username" placeholder="Benutzername" autocomplete="username">
  <input id="password" type="password" placeholder="Passwort" autocomplete="current-password">
  <button id="loginBtn" onclick="login()">Login</button>
  <p id="msg"></p>
</div>

<!-- Suche (Position bleibt, Icon sitzt im Input) -->
<div class="searchWrapper" id="searchWrapper">
  <div class="searchInner">
    <div id="searchIcon">üîé</div>
    <input id="searchBox" class="glass" placeholder="Suche...">
  </div>
</div>

<!-- Right pills -->
<button id="logoutBtn" class="pillBtn glass" onclick="logout()" style="display:none;">
  <span class="pillIcon">‚éã</span>
  <span>Logout</span>
</button>

<div id="adminToggle" class="pillBtn glass" style="display:none;">
  <span class="pillIcon">‚öô</span>
  <span>Admin</span>
</div>

<!-- Admin Panel -->
<div id="adminPanel" class="glass">
  <h3>Marker Verwaltung</h3>

  <div id="coordBadge">
    <b>üñ±Ô∏è Keine Koordinate gew√§hlt</b>
    <span>Klicke in die Karte, um einen neuen Marker zu platzieren.</span>
  </div>

  <div class="panelLabel">Titel</div>
  <input id="mTitle" placeholder="Titel">

  <div class="panelLabel">Beschreibung</div>
  <input id="mDesc" placeholder="Beschreibung">

  <div class="iconPickerTitle">Icon (optional)</div>
  <div class="iconPicker">
    <div class="iconPick active" id="pickDot" onclick="setIcon('')">
      <div id="dotPreview" style="width:16px;height:16px;border-radius:50%;border:2px solid #fff;background:#666;"></div>
      <small>Punkt</small>
    </div>

    <div class="iconPick" id="pickHouse" onclick="setIcon('house')">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M12 3.2 3 10.2v10.2c0 .9.7 1.6 1.6 1.6H9.8v-6.3c0-.7.5-1.2 1.2-1.2h2c.7 0 1.2.5 1.2 1.2V22h5.2c.9 0 1.6-.7 1.6-1.6V10.2L12 3.2z"/>
      </svg>
      <small>Haus</small>
    </div>

    <div class="iconPick" id="pickLab" onclick="setIcon('lab')">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path fill="currentColor" d="M9 2h6v2h-1v5l5 8.5c1 1.7-.2 3.5-2.2 3.5H7.2c-2 0-3.2-1.8-2.2-3.5L10 9V4H9V2z"/>
      </svg>
      <small>Labor</small>
    </div>
  </div>

  <div class="panelLabel">Farbe</div>
  <div class="colorRow">
    <input id="mColor" type="color" value="#ff0000" onchange="updateColorPreview()" title="Farbe">
  </div>

  <div class="panelBtnRow">
    <button class="saveBtn" onclick="saveMarker()">Speichern</button>
    <button class="delBtn" onclick="deleteMarker()">L√∂schen</button>
  </div>
</div>

<div id="coords" class="glass"></div>
<div id="map"></div>

<button id="fraktionenBtn" class="glass" onclick="window.location='fraktionen.html'">üè¥ Fraktionen</button>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL="https://lleldalugvgmgqekcolx.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxsZWxkYWx1Z3ZnbWdxZWtjb2x4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTg4OTgsImV4cCI6MjA4NzM3NDg5OH0.CuiVJ9kWraso1tLEJ3D6V4IssYGVeWaLs2ygerVU5tc";
const db=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

let map, markerLayer;
let isAdmin=false;

let selectedCoords=null;     // nur f√ºr NEU
let currentEditId=null;      // f√ºr EDIT
let allMarkers=[];

let inactivityTimer;

// Desktop Hover Erkennung: nur wenn echte Hover-Maus vorhanden
const isDesktopHover = window.matchMedia("(hover: hover) and (pointer: fine)").matches;

// Icon state ("" => Punkt)
let selectedIcon = "";

/* ================= AUTO LOGOUT ================= */
function resetInactivityTimer(){
  clearTimeout(inactivityTimer);
  inactivityTimer=setTimeout(()=>{
    alert("Automatischer Logout wegen Inaktivit√§t (60 Minuten)");
    logout();
  },60*60*1000);
}
document.addEventListener("mousemove",resetInactivityTimer);
document.addEventListener("keydown",resetInactivityTimer);
document.addEventListener("click",resetInactivityTimer);
document.addEventListener("touchstart",resetInactivityTimer);

/* ================= LOGIN ================= */
document.addEventListener("keydown",e=>{
  if(e.key==="Enter") login();
});

window.onload=async()=>{
  const {data}=await db.auth.getSession();
  if(data.session){
    isAdmin = ((data.session.user.email || "").toLowerCase() === "admin@gta.local");
    startApp();
  }
};

async function login(){
  const username=document.getElementById("username").value.toLowerCase().trim();
  const password=document.getElementById("password").value;

  const {error}=await db.auth.signInWithPassword({
    email:username+"@gta.local",
    password
  });

  if(error){
    document.getElementById("msg").innerText="Login fehlgeschlagen";
  }else{
    isAdmin = (username === "admin");
    startApp();
  }
}

async function logout(){
  await db.auth.signOut();
  location.reload();
}

/* ================= START ================= */
function startApp(){
  document.getElementById("loginPanel").style.display="none";
  document.getElementById("map").style.display="block";
  document.getElementById("coords").style.display="block";

  document.getElementById("logoutBtn").style.display="flex";
  document.getElementById("searchWrapper").style.display="block";
  document.getElementById("fraktionenBtn").style.display="block";

  if(isAdmin){
    document.getElementById("adminToggle").style.display="flex";
  }else{
    document.getElementById("adminToggle").style.display="none";
    document.getElementById("adminPanel").classList.remove("open");
  }

  initMap();
  loadMarkers();
  setupRealtime();
  updateColorPreview();
  updateCoordBadge();
  resetInactivityTimer();
}

/* ================= ADMIN PANEL TOGGLE ================= */
document.getElementById("adminToggle").onclick=()=>{
  if(!isAdmin) return;
  document.getElementById("adminPanel").classList.toggle("open");
};

/* ================= COORD BADGE ================= */
function updateCoordBadge(mode){
  const badge=document.getElementById("coordBadge");
  badge.classList.remove("ready","editing");

  if(mode==="editing"){
    badge.classList.add("editing");
    badge.innerHTML = `
      <b>‚úèÔ∏è Bearbeiten-Modus</b>
      <span>Du bearbeitest einen bestehenden Marker.</span>
    `;
    return;
  }

  if(selectedCoords){
    badge.classList.add("ready");
    badge.innerHTML = `
      <b>‚úÖ Koordinate gew√§hlt</b>
      <span>X: ${Math.round(selectedCoords.lng)} &nbsp; | &nbsp; Y: ${Math.round(selectedCoords.lat)}</span>
    `;
  }else{
    badge.innerHTML = `
      <b>üñ±Ô∏è Keine Koordinate gew√§hlt</b>
      <span>Klicke in die Karte, um einen neuen Marker zu platzieren.</span>
    `;
  }
}

/* ================= ICON PICKER ================= */
function setIcon(icon){
  selectedIcon = icon || "";
  document.getElementById("pickDot").classList.toggle("active", selectedIcon==="");
  document.getElementById("pickHouse").classList.toggle("active", selectedIcon==="house");
  document.getElementById("pickLab").classList.toggle("active", selectedIcon==="lab");
}
function setIconFromMarker(icon){
  setIcon(icon || "");
}

/* ================= MAP ================= */
function initMap(){
  map=L.map('map',{crs:L.CRS.Simple,minZoom:-2,maxZoom:2});
  const bounds=[[0,0],[8192,8192]];
  L.imageOverlay("gta_map.png",bounds).addTo(map);
  map.fitBounds(bounds);

  markerLayer=L.layerGroup().addTo(map);

  map.on("mousemove",e=>{
    document.getElementById("coords").innerText =
      "X:"+Math.round(e.latlng.lng)+" | Y:"+Math.round(e.latlng.lat);
  });

  if(isAdmin){
    map.on("click",e=>{
      clearForm();
      selectedCoords=e.latlng;
      currentEditId=null;

      document.getElementById("adminPanel").classList.add("open");
      updateCoordBadge();
    });
  }
}

/* ================= ICON SPECS (Anchor fix gegen Drift) ================= */
function buildMarkerIconSpec(color, icon){
  const safeColor = color || "#ff0000";

  // Punkt
  if(!icon){
    const size = [28,28];
    return {
      html: `<div style="
        width:22px;height:22px;
        border-radius:50%;
        background:${safeColor};
        border:3px solid white;
        box-sizing:content-box;
      "></div>`,
      iconSize: size,
      iconAnchor: [size[0]/2, size[1]/2],
      popupAnchor: [0, -(size[1]/2)]
    };
  }

  // Haus/Labor
  const size = [42,42];
  const strokeW = 1.2;

  if(icon==="house"){
    return {
      html: `<div style="width:${size[0]}px;height:${size[1]}px;display:flex;align-items:center;justify-content:center;">
        <svg viewBox="0 0 24 24" width="${size[0]}" height="${size[1]}">
          <path fill="${safeColor}" stroke="white" stroke-width="${strokeW}"
            d="M12 3.2 3 10.2v10.2c0 .9.7 1.6 1.6 1.6H9.8v-6.3c0-.7.5-1.2 1.2-1.2h2c.7 0 1.2.5 1.2 1.2V22h5.2c.9 0 1.6-.7 1.6-1.6V10.2L12 3.2z"/>
        </svg>
      </div>`,
      iconSize: size,
      iconAnchor: [size[0]/2, size[1]/2],
      popupAnchor: [0, -(size[1]/2)]
    };
  }

  if(icon==="lab"){
    return {
      html: `<div style="width:${size[0]}px;height:${size[1]}px;display:flex;align-items:center;justify-content:center;">
        <svg viewBox="0 0 24 24" width="${size[0]}" height="${size[1]}">
          <path fill="${safeColor}" stroke="white" stroke-width="${strokeW}"
            d="M9 2h6v2h-1v5l5 8.5c1 1.7-.2 3.5-2.2 3.5H7.2c-2 0-3.2-1.8-2.2-3.5L10 9V4H9V2z"/>
        </svg>
      </div>`,
      iconSize: size,
      iconAnchor: [size[0]/2, size[1]/2],
      popupAnchor: [0, -(size[1]/2)]
    };
  }

  // Fallback
  const size2=[28,28];
  return {
    html: `<div style="width:22px;height:22px;border-radius:50%;background:${safeColor};border:3px solid white;"></div>`,
    iconSize:size2,
    iconAnchor:[size2[0]/2,size2[1]/2],
    popupAnchor:[0,-(size2[1]/2)]
  };
}

/* ================= MARKER ================= */
async function loadMarkers(){
  const {data, error}=await db.from("markers").select("*");
  if(error){
    console.error(error);
    allMarkers=[];
  }else{
    allMarkers=data || [];
  }
  renderMarkers(allMarkers);
}

function renderMarkers(data){
  markerLayer.clearLayers();

  data.forEach(m=>{
    const spec = buildMarkerIconSpec(m.color, m.icon);

    const icon = L.divIcon({
      html: spec.html,
      className: "",
      iconSize: spec.iconSize,
      iconAnchor: spec.iconAnchor,
      popupAnchor: spec.popupAnchor
    });

    const marker = L.marker([m.y, m.x], {
      icon,
      draggable: isAdmin
    }).addTo(markerLayer);

    marker.bindPopup("<b>"+(m.title||"")+"</b><br>"+(m.description||""));

    // Hover nur Desktop
    if(isDesktopHover){
      marker.on("mouseover", function(){ this.openPopup(); });
      marker.on("mouseout", function(){ this.closePopup(); });
    }

    if(isAdmin){
      marker.on("click",()=>{
        selectedCoords=null;
        currentEditId=m.id;

        document.getElementById("mTitle").value=m.title || "";
        document.getElementById("mDesc").value=m.description || "";
        document.getElementById("mColor").value=m.color || "#ff0000";
        updateColorPreview();

        setIconFromMarker(m.icon);

        document.getElementById("adminPanel").classList.add("open");
        updateCoordBadge("editing");
      });

      marker.on("dragend", async (e)=>{
        const pos = e.target.getLatLng();
        await db.from("markers")
          .update({x:Math.round(pos.lng), y:Math.round(pos.lat)})
          .eq("id", m.id);
      });
    }
  });
}

async function saveMarker(){
  const title=document.getElementById("mTitle").value.trim();
  const description=document.getElementById("mDesc").value.trim();
  const color=document.getElementById("mColor").value;
  const icon = selectedIcon || null;

  if(!title){ alert("Titel fehlt"); return; }

  if(currentEditId){
    await db.from("markers")
      .update({title, description, color, icon})
      .eq("id", currentEditId);

    clearForm();
    updateCoordBadge();
  }else{
    if(!selectedCoords){ alert("Karte anklicken"); return; }

    await db.from("markers").insert([{
      title, description, color, icon,
      x:Math.round(selectedCoords.lng),
      y:Math.round(selectedCoords.lat)
    }]);

    clearForm();
    selectedCoords=null;
    updateCoordBadge();
  }
}

async function deleteMarker(){
  if(!currentEditId) return;
  await db.from("markers").delete().eq("id", currentEditId);
  clearForm();
  selectedCoords=null;
  updateCoordBadge();
}

function clearForm(){
  document.getElementById("mTitle").value="";
  document.getElementById("mDesc").value="";
  currentEditId=null;
  setIcon("");
}

/* ================= SEARCH ================= */
document.getElementById("searchBox").addEventListener("input",(e)=>{
  const value = e.target.value.toLowerCase();
  const filtered = allMarkers.filter(m =>
    (m.title||"").toLowerCase().includes(value) ||
    (m.description||"").toLowerCase().includes(value)
  );
  renderMarkers(filtered);
});

/* ================= REALTIME ================= */
function setupRealtime(){
  db.channel("realtime-markers")
    .on("postgres_changes",
      {event:"*", schema:"public", table:"markers"},
      ()=>loadMarkers()
    ).subscribe();
}

/* ================= COLOR PREVIEW (nur Punkt-Preview) ================= */
function updateColorPreview(){
  const v=document.getElementById("mColor").value;
  const dot=document.getElementById("dotPreview");
  if(dot) dot.style.background=v;
}
</script>
</body>
</html>
